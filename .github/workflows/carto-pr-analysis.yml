name: CARTO PR Analysis

# Manual workflow to analyze CARTO PRs and generate a report.
# Useful for debugging and inspecting which files are considered CARTO-modified.
#
# The resolver and ci-fixer workflows have this logic inlined because they
# check out sync branches that don't have access to local actions.

on:
  workflow_dispatch:
    inputs:
      debug:
        description: "Show detailed file list"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read

jobs:
  analyze:
    name: Analyze CARTO PRs
    runs-on: ubuntu-latest

    steps:
      - name: Analyze CARTO PRs
        id: analyze
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          echo "::group::Fetching CartoDB org members"

          ORG_MEMBERS=$(gh api "orgs/CartoDB/members" --paginate --jq '.[].login' 2>/dev/null | tr '\n' '|' | sed 's/|$//')

          if [ -z "$ORG_MEMBERS" ]; then
            echo "Warning: Could not fetch org members, using fallback"
            ORG_MEMBERS="Cartofante|mateo-di"
          fi

          MEMBER_COUNT=$(echo "$ORG_MEMBERS" | tr '|' '\n' | wc -l | tr -d ' ')
          echo "Found ${MEMBER_COUNT} org members"
          echo "::endgroup::"

          echo "::group::Fetching PRs merged to carto/main"

          gh pr list \
            --repo ${{ github.repository }} \
            --base carto/main \
            --state merged \
            --limit 1000 \
            --json number,title,author,mergedAt,files \
            > all_prs.json 2>/dev/null || echo "[]" > all_prs.json

          TOTAL_PRS=$(jq 'length' all_prs.json)
          echo "Found ${TOTAL_PRS} total PRs merged to carto/main"

          # Filter to CARTO org member authors only
          jq --arg pattern "$ORG_MEMBERS" '
            [.[] | select(.author.login | test("^(" + $pattern + ")$"; "i"))]
          ' all_prs.json > carto_prs.json

          CARTO_PRS=$(jq 'length' carto_prs.json)
          echo "Found ${CARTO_PRS} PRs by CARTO org members"

          # Extract unique file paths
          jq -r '[.[] | .files[].path] | unique | .[]' carto_prs.json > carto_files.txt

          FILE_COUNT=$(wc -l < carto_files.txt | tr -d ' ')
          echo "Found ${FILE_COUNT} unique CARTO-modified files"

          echo "total-prs=${TOTAL_PRS}" >> $GITHUB_OUTPUT
          echo "carto-prs=${CARTO_PRS}" >> $GITHUB_OUTPUT
          echo "file-count=${FILE_COUNT}" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Show results
        run: |
          echo "## CARTO PR Analysis Results"
          echo ""
          echo "| Metric | Count |"
          echo "|--------|-------|"
          echo "| Total PRs to carto/main | ${{ steps.analyze.outputs.total-prs }} |"
          echo "| PRs by CARTO org members | ${{ steps.analyze.outputs.carto-prs }} |"
          echo "| CARTO-modified files | ${{ steps.analyze.outputs.file-count }} |"
          echo ""

          echo "### Recent CARTO PRs"
          jq -r '
            sort_by(.mergedAt) | reverse | .[0:20] |
            .[] | "- PR #\(.number): \(.title) (@\(.author.login))"
          ' carto_prs.json

          if [ "${{ inputs.debug }}" == "true" ]; then
            echo ""
            echo "### All CARTO-modified files"
            cat carto_files.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: carto-pr-analysis
          path: |
            carto_prs.json
            carto_files.txt
          retention-days: 2

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## CARTO PR Analysis

          | Metric | Count |
          |--------|-------|
          | Total PRs to carto/main | ${{ steps.analyze.outputs.total-prs }} |
          | PRs by CARTO org members | ${{ steps.analyze.outputs.carto-prs }} |
          | CARTO-modified files | ${{ steps.analyze.outputs.file-count }} |

          ### How This Data Is Used

          The resolver and ci-fixer workflows run this same analysis inline to:
          - Classify conflicted files as CARTO-modified vs upstream-only
          - Help Claude understand which files have CARTO customizations
          EOF
