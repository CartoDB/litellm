name: CARTO PR Analysis

# This workflow provides a standalone way to run CARTO PR analysis.
# The primary analysis is done by the composite action at:
#   .github/actions/carto-pr-analysis/action.yml
#
# This workflow is useful for:
# - Manual debugging and testing
# - Generating downloadable artifacts for inspection
# - Pre-warming analysis before resolver runs
#
# The resolver and ci-fixer workflows call the action directly,
# so this workflow is not required for normal operation.

on:
  workflow_dispatch:
    inputs:
      debug:
        description: "Show detailed output"
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read

jobs:
  analyze:
    name: Analyze CARTO PRs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run CARTO PR analysis
        id: analysis
        uses: ./.github/actions/carto-pr-analysis
        with:
          github_token: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
          output_path: ./carto-analysis

      - name: Generate summary report
        run: |
          echo "::group::Generating summary"

          cat > ./carto-analysis/carto_analysis.md << EOF
          # CARTO PR Analysis

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}

          ## Summary

          | Metric | Count |
          |--------|-------|
          | PRs by CARTO org members | ${{ steps.analysis.outputs.pr_count }} |
          | Files touched by CARTO PRs | ${{ steps.analysis.outputs.file_count }} |

          ## How This Data Is Used

          **Conflict Resolution:**
          - Files in \`carto_files.txt\` are classified as CARTO-modified
          - Conflicts in these files preserve CARTO changes
          - Files NOT in the list accept upstream version

          **CI Fixer:**
          - Helps Claude understand which failing files have CARTO customizations
          - Guides fix strategy (preserve CARTO vs accept upstream)

          ## Recent CARTO PRs

          $(jq -r '
            sort_by(.mergedAt) | reverse | .[0:20] |
            .[] | "- PR #\(.number): \(.title) (@\(.author.login), \(.mergedAt | split("T")[0]))"
          ' ./carto-analysis/carto_prs.json 2>/dev/null || echo "No PRs found")

          ## File Categories

          **Top directories with CARTO modifications:**
          $(cat ./carto-analysis/carto_files.txt 2>/dev/null | xargs -I {} dirname {} | sort | uniq -c | sort -rn | head -10 | awk '{print "- " $2 " (" $1 " files)"}' || echo "No files found")
          EOF

          if [ "${{ inputs.debug }}" == "true" ]; then
            echo "=== CARTO Files ==="
            cat ./carto-analysis/carto_files.txt
            echo ""
            echo "=== CARTO PRs (first 10) ==="
            jq '.[0:10]' ./carto-analysis/carto_prs.json
          fi

          echo "::endgroup::"

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: carto-pr-analysis
          path: |
            ./carto-analysis/carto_prs.json
            ./carto-analysis/carto_files.txt
            ./carto-analysis/carto_analysis.md
          retention-days: 30

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## CARTO PR Analysis Complete

          | Metric | Count |
          |--------|-------|
          | PRs by CARTO org members | ${{ steps.analysis.outputs.pr_count }} |
          | Files touched by CARTO PRs | ${{ steps.analysis.outputs.file_count }} |

          ### Artifacts Generated

          - \`carto_prs.json\` - Full PR data with file lists
          - \`carto_files.txt\` - Simple list of CARTO-modified files
          - \`carto_analysis.md\` - Human-readable summary

          > **Note:** The resolver and ci-fixer workflows call the action directly.
          > This workflow is for manual debugging and artifact generation.
          EOF
