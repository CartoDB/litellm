name: CARTO Upstream Sync - Feature Verifier

# This workflow verifies CARTO LiteLLM code features are preserved after upstream sync.
# It can auto-fix missing features by triggering Claude to implement them.
#
# Triggers:
# 1. Manual: workflow_dispatch with PR number
# 2. Auto: After CI-fixer completes successfully
# 3. Auto: After CI workflows pass on upstream-sync branches
#
# Jobs:
# 1. verify-features: Check if CARTO code features exist in PR
# 2. fix-missing-features: If issues found, Claude implements missing features

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      pr-number:
        description: "PR number to verify"
        required: true
      auto-fix:
        description: "Automatically fix missing features"
        type: boolean
        default: true
      debug:
        description: "Enable debug logging"
        type: boolean
        default: false

  # Auto-trigger after CI-fixer completes
  workflow_run:
    workflows:
      - "CARTO Upstream Sync - CI Failure Auto-Fix"
    types:
      - completed
    branches:
      - 'upstream-sync/**'

# Prevent multiple runs on the same PR
concurrency:
  group: feature-verifier-${{ github.event.inputs.pr-number || github.event.workflow_run.pull_requests[0].number || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # Job 1: Determine if we should run
  check-trigger:
    name: Check Trigger Conditions
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      branch-name: ${{ steps.check.outputs.branch-name }}
      auto-fix: ${{ steps.check.outputs.auto-fix }}

    steps:
      - name: Determine PR and conditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          echo "::group::Checking trigger conditions"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger
            PR_NUMBER="${{ github.event.inputs.pr-number }}"
            AUTO_FIX="${{ github.event.inputs.auto-fix }}"
            echo "[Verifier] Manual trigger for PR #${PR_NUMBER}"
          else
            # workflow_run trigger - only run if previous workflow succeeded
            if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
              echo "[Verifier] Previous workflow did not succeed - skipping"
              echo "should-run=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Get PR from workflow_run
            BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
            PR_JSON=$(gh pr list --repo ${{ github.repository }} --head "${BRANCH_NAME}" --json number,labels --jq '.[0]')

            if [[ -z "${PR_JSON}" || "${PR_JSON}" == "null" ]]; then
              echo "[Verifier] No PR found for branch ${BRANCH_NAME}"
              echo "should-run=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            PR_NUMBER=$(echo "${PR_JSON}" | jq -r '.number')
            AUTO_FIX="true"  # Auto-fix enabled for automatic triggers
            echo "[Verifier] Auto-trigger for PR #${PR_NUMBER}"
          fi

          # Get PR details
          PR_INFO=$(gh pr view ${PR_NUMBER} --repo ${{ github.repository }} --json headRefName,labels,mergeable)
          BRANCH_NAME=$(echo "${PR_INFO}" | jq -r '.headRefName')
          HAS_UPSTREAM_SYNC=$(echo "${PR_INFO}" | jq '[.labels[].name] | any(. == "upstream-sync")')

          # Only run on upstream-sync PRs
          if [[ "${HAS_UPSTREAM_SYNC}" != "true" ]]; then
            echo "[Verifier] PR #${PR_NUMBER} is not an upstream-sync PR - skipping"
            echo "should-run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "[Verifier] PR #${PR_NUMBER} on branch ${BRANCH_NAME}"
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "auto-fix=${AUTO_FIX}" >> $GITHUB_OUTPUT

          echo "::endgroup::"

  # Job 2: Verify CARTO features
  verify-features:
    name: Verify CARTO LiteLLM Features
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run == 'true'

    outputs:
      has-issues: ${{ steps.analyze-report.outputs.has-issues }}
      missing-count: ${{ steps.analyze-report.outputs.missing-count }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.branch-name }}
          fetch-depth: 0
          token: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}

      - name: Configure git
        run: |
          git config --global user.name "Cartofante"
          git config --global user.email "cartofante@carto.com"

      - name: Comment on PR - Starting verification
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          gh pr comment ${{ needs.check-trigger.outputs.pr-number }} \
            --repo ${{ github.repository }} \
            --body "## üîç CARTO Feature Verification Started

          Analyzing CARTO LiteLLM code features in \`litellm/\` and \`tests/\`.

          | Check | Status |
          |-------|--------|
          | Extract CARTO PRs | ‚è≥ |
          | Compare patterns | ‚è≥ |
          | Generate report | ‚è≥ |

          [View workflow ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Analyze CARTO PRs for feature context
        id: analyze-prs
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          echo "::group::Analyzing CARTO PRs"

          mkdir -p /tmp/carto-analysis

          # Fetch CartoDB org members
          ORG_MEMBERS=$(gh api "orgs/CartoDB/members" --paginate --jq '.[].login' 2>/dev/null | tr '\n' '|' | sed 's/|$//')
          if [ -z "$ORG_MEMBERS" ]; then
            ORG_MEMBERS="Cartofante|mateo-di"
          fi

          # Fetch merged PRs to carto/main
          gh pr list \
            --repo ${{ github.repository }} \
            --base carto/main \
            --state merged \
            --limit 1000 \
            --json number,title,author,mergedAt,files,labels \
            > /tmp/carto-analysis/all_prs.json 2>/dev/null || echo "[]" > /tmp/carto-analysis/all_prs.json

          # Filter: CARTO org members, exclude upstream-sync, only litellm/tests files
          jq --arg pattern "$ORG_MEMBERS" '
            [.[] |
              select(.author.login | test("^(" + $pattern + ")$"; "i")) |
              select(([(.labels // [])[].name] | any(. == "upstream-sync")) | not) |
              select(.title | test("^(sync:|upstream sync:|fix: resolve|fix\\(ci\\):|merge:)"; "i") | not) |
              . + {files: [.files[] | select(.path | test("^(litellm/|tests/)"))]} |
              select(.files | length > 0)
            ]
          ' /tmp/carto-analysis/all_prs.json > /tmp/carto-analysis/carto_prs.json

          CARTO_PR_COUNT=$(jq 'length' /tmp/carto-analysis/carto_prs.json)
          echo "[Verifier] Found ${CARTO_PR_COUNT} CARTO feature PRs"
          echo "carto-pr-count=${CARTO_PR_COUNT}" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Generate verification report
        id: generate-report
        run: |
          echo "::group::Generating verification report"

          # Initialize report
          REPORT_FILE="/tmp/carto_verification_report.md"
          > "$REPORT_FILE"

          echo "# CARTO Feature Verification Report" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**PR:** #${{ needs.check-trigger.outputs.pr-number }}" >> "$REPORT_FILE"
          echo "**Branch:** \`${{ needs.check-trigger.outputs.branch-name }}\`" >> "$REPORT_FILE"
          echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Summary section (will be filled later)
          echo "## Summary" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "<!-- SUMMARY_PLACEHOLDER -->" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          echo "## Detailed Analysis" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Track counts
          TOTAL_FILES=0
          PRESENT_FILES=0
          MISSING_FILES=0
          MODIFIED_FILES=0
          MISSING_PATTERNS=""

          # Analyze each CARTO file
          for FILE in $(jq -r '[.[] | .files[].path] | unique | .[]' /tmp/carto-analysis/carto_prs.json | head -30); do
            TOTAL_FILES=$((TOTAL_FILES + 1))

            # Get PRs that touched this file
            FILE_PRS=$(jq -r --arg f "$FILE" '[.[] | select(.files | map(.path) | any(. == $f)) | "#\(.number)"] | join(", ")' /tmp/carto-analysis/carto_prs.json)

            echo "### \`$FILE\`" >> "$REPORT_FILE"
            echo "**Source PRs:** $FILE_PRS" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"

            if [ ! -f "$FILE" ]; then
              MISSING_FILES=$((MISSING_FILES + 1))
              echo "**Status:** ‚ùå **FILE MISSING**" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              MISSING_PATTERNS="${MISSING_PATTERNS}\n- \`$FILE\` (entire file missing)"
              continue
            fi

            # Extract patterns from carto/main
            CARTO_PATTERNS=$(git show origin/carto/main:"$FILE" 2>/dev/null | grep -E "^\s*(def |class |async def )" | sed 's/(.*//;s/^\s*//' | sort -u)
            # Extract patterns from current PR
            PR_PATTERNS=$(grep -E "^\s*(def |class |async def )" "$FILE" 2>/dev/null | sed 's/(.*//;s/^\s*//' | sort -u)

            # Find missing patterns
            MISSING=$(comm -23 <(echo "$CARTO_PATTERNS" | sort) <(echo "$PR_PATTERNS" | sort) | grep -v "^$" || true)

            if [ -z "$MISSING" ]; then
              PRESENT_FILES=$((PRESENT_FILES + 1))
              echo "**Status:** ‚úÖ All patterns present" >> "$REPORT_FILE"
            else
              MODIFIED_FILES=$((MODIFIED_FILES + 1))
              echo "**Status:** ‚ö†Ô∏è **PATTERNS MISSING**" >> "$REPORT_FILE"
              echo "" >> "$REPORT_FILE"
              echo "Missing from PR:" >> "$REPORT_FILE"
              echo '```' >> "$REPORT_FILE"
              echo "$MISSING" >> "$REPORT_FILE"
              echo '```' >> "$REPORT_FILE"

              for PATTERN in $MISSING; do
                MISSING_PATTERNS="${MISSING_PATTERNS}\n- \`$FILE\`: \`$PATTERN\`"
              done
            fi

            echo "" >> "$REPORT_FILE"
            echo "<details>" >> "$REPORT_FILE"
            echo "<summary>Pattern comparison</summary>" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**carto/main patterns:**" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            echo "$CARTO_PATTERNS" | head -15 >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**PR patterns:**" >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            echo "$PR_PATTERNS" | head -15 >> "$REPORT_FILE"
            echo '```' >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
          done

          # Fill in summary
          ISSUES_COUNT=$((MISSING_FILES + MODIFIED_FILES))
          if [ $ISSUES_COUNT -eq 0 ]; then
            OVERALL_STATUS="‚úÖ **PASS** - All CARTO features preserved"
          else
            OVERALL_STATUS="‚ö†Ô∏è **NEEDS ATTENTION** - ${ISSUES_COUNT} file(s) with issues"
          fi

          SUMMARY="| Metric | Count |
          |--------|-------|
          | Total CARTO files | ${TOTAL_FILES} |
          | ‚úÖ Fully preserved | ${PRESENT_FILES} |
          | ‚ùå Missing files | ${MISSING_FILES} |
          | ‚ö†Ô∏è Missing patterns | ${MODIFIED_FILES} |

          **Overall:** ${OVERALL_STATUS}"

          sed -i "s|<!-- SUMMARY_PLACEHOLDER -->|${SUMMARY}|" "$REPORT_FILE"

          # Add missing patterns section if any
          if [ -n "$MISSING_PATTERNS" ]; then
            echo "" >> "$REPORT_FILE"
            echo "## Missing Patterns to Implement" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo -e "$MISSING_PATTERNS" >> "$REPORT_FILE"
          fi

          # Save counts for next job
          echo "total-files=${TOTAL_FILES}" >> $GITHUB_OUTPUT
          echo "present-files=${PRESENT_FILES}" >> $GITHUB_OUTPUT
          echo "missing-files=${MISSING_FILES}" >> $GITHUB_OUTPUT
          echo "modified-files=${MODIFIED_FILES}" >> $GITHUB_OUTPUT

          # Save missing patterns for fix job
          echo -e "$MISSING_PATTERNS" > /tmp/missing_patterns.txt

          cat "$REPORT_FILE"
          echo "::endgroup::"

      - name: Analyze report for issues
        id: analyze-report
        run: |
          MISSING_FILES="${{ steps.generate-report.outputs.missing-files }}"
          MODIFIED_FILES="${{ steps.generate-report.outputs.modified-files }}"
          ISSUES_COUNT=$((MISSING_FILES + MODIFIED_FILES))

          if [ $ISSUES_COUNT -gt 0 ]; then
            echo "has-issues=true" >> $GITHUB_OUTPUT
            echo "missing-count=${ISSUES_COUNT}" >> $GITHUB_OUTPUT
          else
            echo "has-issues=false" >> $GITHUB_OUTPUT
            echo "missing-count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload verification report
        uses: actions/upload-artifact@v4
        with:
          name: carto-verification-report
          path: /tmp/carto_verification_report.md

      - name: Upload missing patterns
        if: steps.analyze-report.outputs.has-issues == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: missing-patterns
          path: /tmp/missing_patterns.txt

      - name: Comment on PR - Verification results
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          PR_NUMBER="${{ needs.check-trigger.outputs.pr-number }}"
          HAS_ISSUES="${{ steps.analyze-report.outputs.has-issues }}"
          TOTAL="${{ steps.generate-report.outputs.total-files }}"
          PRESENT="${{ steps.generate-report.outputs.present-files }}"
          MISSING="${{ steps.generate-report.outputs.missing-files }}"
          MODIFIED="${{ steps.generate-report.outputs.modified-files }}"

          if [ "${HAS_ISSUES}" == "true" ]; then
            STATUS="‚ö†Ô∏è **NEEDS ATTENTION**"
            NEXT_STEP="The **Feature Fixer** job will attempt to implement missing features."
          else
            STATUS="‚úÖ **PASS**"
            NEXT_STEP="No action needed - all CARTO features are preserved."
          fi

          gh pr comment ${PR_NUMBER} \
            --repo ${{ github.repository }} \
            --body "## üîç CARTO Feature Verification Complete

          ${STATUS}

          | Metric | Count |
          |--------|-------|
          | Total CARTO files | ${TOTAL} |
          | ‚úÖ Fully preserved | ${PRESENT} |
          | ‚ùå Missing files | ${MISSING} |
          | ‚ö†Ô∏è Missing patterns | ${MODIFIED} |

          **Next:** ${NEXT_STEP}

          [üìã Full Report ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

  # Job 3: Fix missing features (if any)
  fix-missing-features:
    name: Fix Missing CARTO Features
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [check-trigger, verify-features]
    if: |
      needs.verify-features.outputs.has-issues == 'true' &&
      needs.check-trigger.outputs.auto-fix == 'true'

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.branch-name }}
          fetch-depth: 0
          token: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}

      - name: Configure git
        run: |
          git config --global user.name "Cartofante"
          git config --global user.email "cartofante@carto.com"

      - name: Download verification report
        uses: actions/download-artifact@v4
        with:
          name: carto-verification-report
          path: /tmp/

      - name: Download missing patterns
        uses: actions/download-artifact@v4
        with:
          name: missing-patterns
          path: /tmp/

      - name: Comment on PR - Starting fix
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          gh pr comment ${{ needs.check-trigger.outputs.pr-number }} \
            --repo ${{ github.repository }} \
            --body "## üîß CARTO Feature Fixer Started

          **Missing features:** ${{ needs.verify-features.outputs.missing-count }}

          Claude Code is implementing missing CARTO features.

          [View workflow ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Setup GCP credentials for Vertex AI
        run: |
          echo '${{ secrets.CI_RESOURCES_SERVICE_ACCOUNT }}' > /tmp/gcp-sa.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-sa.json" >> $GITHUB_ENV

      - name: Run Claude Code to fix missing features
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          use_vertex: "true"
          github_token: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
          show_full_output: true
          claude_args: "--model claude-opus-4-5@20251101 --max-turns 200 --allowedTools Read,Write,Edit,Bash,Grep,Glob ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}"
          prompt: |
            # CARTO Feature Fixer

            ## YOUR PRIMARY GOAL

            Implement missing CARTO features in this upstream sync PR.
            Read the verification report, understand what's missing, and add the CARTO functionality.

            ---

            ## CONTEXT

            **PR:** #${{ needs.check-trigger.outputs.pr-number }}
            **Branch:** `${{ needs.check-trigger.outputs.branch-name }}`
            **Missing features:** ${{ needs.verify-features.outputs.missing-count }}

            ---

            ## STEP 1: Read the verification report

            ```bash
            cat /tmp/carto_verification_report.md
            ```

            And the list of missing patterns:
            ```bash
            cat /tmp/missing_patterns.txt
            ```

            ---

            ## STEP 2: For each missing file/pattern, implement the CARTO feature

            For each item in `/tmp/missing_patterns.txt`:

            1. **Read the carto/main version** to understand the CARTO feature:
               ```bash
               git show origin/carto/main:path/to/file.py
               ```

            2. **Read the current PR version** to understand the upstream structure:
               ```bash
               cat path/to/file.py
               ```

            3. **Implement the CARTO feature** in the upstream code structure:
               - If file is missing: copy from carto/main
               - If patterns are missing: add the CARTO functions to the upstream file
               - Preserve upstream functionality while adding CARTO features

            4. **Verify the implementation** compiles/imports correctly

            ---

            ## STEP 3: Verify your changes

            ```bash
            # Check syntax
            python3 -m py_compile path/to/modified/file.py

            # Quick Docker build test
            docker build -f docker/Dockerfile.non_root . 2>&1 | tail -50
            ```

            ---

            ## STEP 4: Commit and push

            ```bash
            git add -A
            git commit -m "feat(carto): implement missing CARTO features

            Added CARTO features that were missing after upstream sync:
            [list the features you implemented]

            These features are required for CARTO-specific functionality."

            git push origin ${{ needs.check-trigger.outputs.branch-name }}
            ```

            ---

            ## STEP 5: Comment summary on PR

            ```bash
            gh pr comment ${{ needs.check-trigger.outputs.pr-number }} --repo ${{ github.repository }} --body "## üîß CARTO Feature Fix Applied

            **Implemented features:**
            - [list each feature you implemented]

            **Verification:** [passed/failed]"
            ```

            ---

            ## SAY "FIX COMPLETE" WHEN DONE

        env:
          ANTHROPIC_VERTEX_PROJECT_ID: carto-ci-resources
          CLOUD_ML_REGION: global
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
          GITHUB_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}

      - name: Cleanup GCP credentials
        if: always()
        run: rm -f /tmp/gcp-sa.json

      - name: Comment on PR - Fix result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.X_GITHUB_SUPERCARTOFANTE }}
        run: |
          PR_NUMBER="${{ needs.check-trigger.outputs.pr-number }}"

          if [ "${{ steps.claude-fix.outcome }}" == "success" ]; then
            gh pr comment ${PR_NUMBER} \
              --repo ${{ github.repository }} \
              --body "## ‚úÖ CARTO Feature Fix Complete

          Missing CARTO features have been implemented and pushed.

          CI will run automatically. If issues persist, manual review may be needed.

          [View changes ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          else
            gh pr comment ${PR_NUMBER} \
              --repo ${{ github.repository }} \
              --body "## ‚ùå CARTO Feature Fix Failed

          The automated fix encountered an error. Manual intervention required.

          [View logs ‚Üí](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          fi
