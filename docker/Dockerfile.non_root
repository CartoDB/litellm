# Base images - Using wolfi-base to control Python version (avoids Python 3.14 issues)
# See: https://github.com/BerriAI/litellm/pull/17406
ARG LITELLM_BUILD_IMAGE=cgr.dev/chainguard/wolfi-base
ARG LITELLM_RUNTIME_IMAGE=cgr.dev/chainguard/wolfi-base

# -----------------
# Builder Stage
# -----------------
FROM $LITELLM_BUILD_IMAGE AS builder
WORKDIR /app

# Install build dependencies including Python and Node.js for UI build
USER root
RUN apk add --no-cache \
    python3 \
    py3-pip \
    build-base \
    bash \
    nodejs \
    npm \
  && pip install --no-cache-dir --upgrade pip build

# Copy project files
COPY . .

# Set LITELLM_NON_ROOT flag for build time
ENV LITELLM_NON_ROOT=true

# Build Admin UI
RUN mkdir -p /tmp/litellm_ui

RUN npm install -g npm@latest && npm cache clean --force

RUN cd /app/ui/litellm-dashboard && \
  if [ -f "/app/enterprise/enterprise_ui/enterprise_colors.json" ]; then \
    cp /app/enterprise/enterprise_ui/enterprise_colors.json ./ui_colors.json; \
  fi

RUN cd /app/ui/litellm-dashboard && rm -f package-lock.json

RUN cd /app/ui/litellm-dashboard && npm install --legacy-peer-deps

RUN cd /app/ui/litellm-dashboard && npm run build

RUN cp -r /app/ui/litellm-dashboard/out/* /tmp/litellm_ui/

# --- Pre-cache Prisma binaries in builder stage ---
# Configure Prisma cache directories
ENV PRISMA_BINARY_CACHE_DIR=/app/.cache/prisma-python/binaries
ENV PRISMA_CLI_BINARY_TARGETS="debian-openssl-3.0.x"

# Install prisma and nodejs-bin packages
RUN pip install --no-cache-dir prisma==0.11.0 nodejs-bin==18.4.0a4 && \
    mkdir -p /app/.cache/npm

# Dynamically detect Python version and set up paths
# Copy packages to version-agnostic location for runtime stage
RUN PYTHON_VERSION=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')") && \
    SITE_PACKAGES="/usr/lib/python${PYTHON_VERSION}/site-packages" && \
    echo "Detected Python version: ${PYTHON_VERSION}" && \
    mkdir -p /app/.python-packages && \
    cp -r ${SITE_PACKAGES}/nodejs* /app/.python-packages/ && \
    cp -r ${SITE_PACKAGES}/prisma* /app/.python-packages/ && \
    cp -r ${SITE_PACKAGES}/tomlkit* /app/.python-packages/ && \
    cp -r ${SITE_PACKAGES}/nodeenv* /app/.python-packages/ && \
    ln -sf ${SITE_PACKAGES}/nodejs/bin /app/.nodejs-bin

# Set PATH for Node.js using symlink
ENV PATH="/app/.nodejs-bin:${PATH}"

# Download Prisma CLI and all required binaries
RUN NPM_CONFIG_CACHE=/app/.cache/npm \
    python -c "import prisma.cli.prisma as p; p.ensure_cached()"

# Run Prisma commands to ensure all engines are downloaded
RUN prisma generate && \
    prisma --version && \
    prisma migrate diff --from-empty --to-schema-datamodel ./schema.prisma --script > /dev/null 2>&1 || true

RUN cd /tmp/litellm_ui && \
  for html_file in *.html; do \
    if [ "$html_file" != "index.html" ] && [ -f "$html_file" ]; then \
      folder_name="${html_file%.html}" && \
      mkdir -p "$folder_name" && \
      mv "$html_file" "$folder_name/index.html"; \
    fi; \
  done

RUN cd /app/ui/litellm-dashboard && rm -rf ./out

# Build package and wheel dependencies
RUN rm -rf dist/* && python -m build && \
  pip install dist/*.whl && \
  pip wheel --no-cache-dir --wheel-dir=/wheels/ -r requirements.txt

# -----------------
# Runtime Stage
# -----------------
FROM $LITELLM_RUNTIME_IMAGE AS runtime
WORKDIR /app

# Install runtime dependencies including Python
USER root
RUN apk upgrade --no-cache && \
  apk add --no-cache python3 py3-pip bash libstdc++ ca-certificates openssl supervisor nodejs npm

# Copy only necessary artifacts from builder stage for runtime
COPY . .
COPY --from=builder /app/docker/entrypoint.sh /app/docker/prod_entrypoint.sh /app/docker/
COPY --from=builder /app/docker/supervisord.conf /etc/supervisord.conf
COPY --from=builder /app/schema.prisma /app/schema.prisma
COPY --from=builder /app/dist/*.whl .
COPY --from=builder /wheels/ /wheels/
# Copy pre-cached Prisma binaries, CLI, and npm cache from builder stage
COPY --from=builder /app/.cache /app/.cache
# Copy litellm-proxy-extras directory if it has migrations
COPY --from=builder /app/litellm-proxy-extras /app/litellm-proxy-extras
# Copy built Admin UI from builder
COPY --from=builder /tmp/litellm_ui /tmp/litellm_ui
# Copy version-agnostic python packages cache from builder
COPY --from=builder /app/.python-packages /app/.python-packages
# Copy the prisma executables
COPY --from=builder /usr/bin/prisma /usr/bin/prisma
COPY --from=builder /usr/bin/prisma-client-py /usr/bin/prisma-client-py

# Install packages from version-agnostic cache to the correct site-packages location
RUN PYTHON_VERSION=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')") && \
    SITE_PACKAGES="/usr/lib/python${PYTHON_VERSION}/site-packages" && \
    echo "Runtime Python version: ${PYTHON_VERSION}" && \
    cp -r /app/.python-packages/* ${SITE_PACKAGES}/ && \
    ln -sf ${SITE_PACKAGES}/nodejs/bin /app/.nodejs-bin && \
    rm -rf /app/.python-packages

# Install package from wheel and dependencies
RUN pip install *.whl /wheels/* --no-index --find-links=/wheels/ \
  && rm -f *.whl \
  && rm -rf /wheels

# Remove test files and keys from dependencies
RUN find /usr/lib -type f -path "*/tornado/test/*" -delete && \
    find /usr/lib -type d -path "*/tornado/test" -delete

# Install semantic_router and aurelio-sdk using script
RUN chmod +x docker/install_auto_router.sh && ./docker/install_auto_router.sh

# Ensure correct JWT library is used (pyjwt not jwt)
RUN pip uninstall jwt -y && \
  pip uninstall PyJWT -y && \
  pip install PyJWT==2.9.0 --no-cache-dir

# --- Prisma Configuration ---
# Use pre-cached binaries from builder stage
ENV PRISMA_BINARY_CACHE_DIR=/app/.cache/prisma-python/binaries
ENV PRISMA_CLI_BINARY_TARGETS="debian-openssl-3.0.x"
ENV NPM_CONFIG_CACHE=/.npm

# Make entrypoints executable
RUN chmod +x docker/entrypoint.sh && \
    chmod +x docker/prod_entrypoint.sh && \
    chmod +x /usr/bin/prisma && \
    chmod +x /usr/bin/prisma-client-py

# Create directories and set permissions for non-root user
RUN mkdir -p /nonexistent /.npm && \
  chown -R nobody:nogroup /app /tmp/litellm_ui /nonexistent /.npm && \
  PRISMA_PATH=$(python -c "import os, prisma; print(os.path.dirname(prisma.__file__))") && \
  chown -R nobody:nogroup $PRISMA_PATH && \
  LITELLM_PKG_MIGRATIONS_PATH="$(python -c 'import os, litellm_proxy_extras; print(os.path.dirname(litellm_proxy_extras.__file__))' 2>/dev/null || echo '')/migrations" && \
  [ -n "$LITELLM_PKG_MIGRATIONS_PATH" ] && chown -R nobody:nogroup $LITELLM_PKG_MIGRATIONS_PATH

# Set PATH using version-agnostic symlink
ENV PATH="/app/.nodejs-bin:${PATH}"

# Verify Prisma CLI works in runtime
RUN prisma --version && \
    prisma generate

# Set permissions for non-root user
RUN chown -R nobody:nogroup /app && \
    chown -R nobody:nogroup /nonexistent && \
    chown -R nobody:nogroup /.npm && \
    PRISMA_PATH=$(python -c "import os, prisma; print(os.path.dirname(prisma.__file__))") && \
    chown -R nobody:nogroup $PRISMA_PATH

# --- OpenShift Compatibility: Apply Red Hat recommended pattern ---
# Get paths for directories that need write access at runtime
RUN PRISMA_PATH=$(python -c "import os, prisma; print(os.path.dirname(prisma.__file__))") && \
  LITELLM_PROXY_EXTRAS_PATH=$(python -c "import os, litellm_proxy_extras; print(os.path.dirname(litellm_proxy_extras.__file__))" 2>/dev/null || echo "") && \
  chgrp -R 0 $PRISMA_PATH /tmp/litellm_ui && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chgrp -R 0 $LITELLM_PROXY_EXTRAS_PATH || true && \
  chmod -R g=u $PRISMA_PATH /tmp/litellm_ui && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chmod -R g=u $LITELLM_PROXY_EXTRAS_PATH || true && \
  chmod -R g+w $PRISMA_PATH /tmp/litellm_ui && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chmod -R g+w $LITELLM_PROXY_EXTRAS_PATH || true

# Switch to non-root user
USER nobody

# Set HOME for prisma generate to have a writable directory
ENV HOME=/app

# Set LITELLM_NON_ROOT flag for runtime
ENV LITELLM_NON_ROOT=true

RUN prisma generate

EXPOSE 4000/tcp

ENTRYPOINT ["/app/docker/prod_entrypoint.sh"]

CMD ["--port", "4000"]